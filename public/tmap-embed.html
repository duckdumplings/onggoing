<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tmap Embed</title>
  <style>
    html,
    body,
    #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
  <script>
    // Tmap SDKëŠ” ë‚´ë¶€ì ìœ¼ë¡œ document.writeë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ, ë°˜ë“œì‹œ íŒŒì„œ ì°¨ë‹¨ ë°©ì‹ìœ¼ë¡œ ì‚½ì…í•´ì•¼ í•©ë‹ˆë‹¤.
    (function () {
      try {
        var params = new URLSearchParams(location.search);
        var key = params.get('appKey') || '';
        document.write('<script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=' + key + '"><\\/script>');
      } catch (e) {
        console.error('Failed to inject Tmap SDK:', e);
      }
    })();
  </script>
</head>

<body>
  <div id="map"></div>
  <script>
    var map = null;
    var polylines = [];
    var markers = [];
    var infoWindows = [];

    function clearMap() {
      polylines.forEach(function (p) { p.setMap(null); });
      markers.forEach(function (m) { m.setMap(null); });
      infoWindows.forEach(function (w) { try { w.setMap(null); } catch (e) { } });
      infoWindows = [];
      polylines = []; markers = [];
    }

    function drawRoute(routeData) {
      if (!routeData) return;
      var features = routeData.features || [];
      var T = window.Tmapv2;
      clearMap();
      var bounds = new T.LatLngBounds();
      var waypoints = (routeData.waypoints || []).map(function (w) { return new T.LatLng(w.latitude, w.longitude); });

      // ê²½ë¡œ ê·¸ë¦¬ê¸°
      for (var idx = 0; idx < features.length; idx++) {
        var feature = features[idx];
        var coords = feature && feature.geometry && feature.geometry.coordinates;
        if (!coords || !coords.length) continue;
        var flat = Array.isArray(coords[0][0]) ? coords.flat(1) : coords;
        var path = flat.map(function (c) { return new T.LatLng(c[1], c[0]); });
        if (path.length === 0) continue;
        polylines.push(new T.Polyline({ path: path, strokeColor: '#FF1744', strokeWeight: 5, map: map }));
        for (var k = 0; k < path.length; k++) { bounds.extend(path[k]); }
      }

      // ê°œì„ ëœ í•€ ë Œë”ë§ - ìƒˆë¡œìš´ ì†ì„±ë“¤ ì²˜ë¦¬
      var waypointData = routeData.waypoints || [];
      for (var i = 0; i < waypointData.length; i++) {
        var waypoint = waypointData[i];
        // lat/lng ì†ì„± ì‚¬ìš© (TmapMainMapì—ì„œ ì „ë‹¬í•˜ëŠ” ì†ì„±ëª…)
        var position = new T.LatLng(waypoint.lat, waypoint.lng);

        // ìƒˆë¡œìš´ ì†ì„±ë“¤ í™•ì¸
        var icon = waypoint.icon || 'ğŸ“';
        var color = waypoint.color || '#3B82F6';
        var label = waypoint.label || (i + 1);
        var priority = waypoint.priority || 1;

        // ì•„ì´ì½˜ê³¼ ìƒ‰ìƒì— ë”°ë¥¸ ë°°ê²½ìƒ‰ ê²°ì •
        var backgroundColor;
        var textColor = '#FFFFFF';

        if (icon === 'ğŸš€') {
          backgroundColor = '#10B981'; // ì¶œë°œì§€ - ì´ˆë¡ìƒ‰
        } else if (icon === 'ğŸ¯') {
          backgroundColor = '#EF4444'; // ë„ì°©ì§€ - ë¹¨ê°„ìƒ‰
        } else if (icon === 'ğŸ“') {
          if (i === 0) {
            backgroundColor = '#3B82F6'; // ì²« ë²ˆì§¸ ê²½ìœ ì§€ - íŒŒë€ìƒ‰
          } else {
            backgroundColor = '#8B5CF6'; // ì¤‘ê°„ ê²½ìœ ì§€ - ë³´ë¼ìƒ‰
          }
        } else {
          backgroundColor = color; // ê¸°ë³¸ ìƒ‰ìƒ
        }

        // í•€ ë‚´ìš© ìƒì„±
        var content = '<div style="' +
          'background:' + backgroundColor + ';' +
          'color:' + textColor + ';' +
          'border-radius:12px;' +
          'padding:4px 8px;' +
          'font-size:14px;' +
          'font-weight:bold;' +
          'box-shadow:0 2px 8px rgba(0,0,0,0.3);' +
          'border:2px solid white;' +
          'min-width:24px;' +
          'text-align:center;' +
          'display:flex;' +
          'align-items:center;' +
          'justify-content:center;' +
          'gap:2px;' +
          '">' +
          '<span style="font-size:12px;">' + icon + '</span>' +
          '<span>' + label + '</span>' +
          '</div>';

        infoWindows.push(new T.InfoWindow({
          position: position,
          content: content,
          type: 2,
          map: map
        }));

        bounds.extend(position);
      }

      // ê²½ë¡œ ì˜ì—­ìœ¼ë¡œ ìë™ ë§ì¶¤
      try {
        if (bounds && typeof bounds.isEmpty === 'function' && !bounds.isEmpty()) {
          map.fitBounds(bounds, 30);
        }
      } catch (e) {
        console.error('Bounds fitting error:', e);
      }
    }

    function ensureMap(center) {
      if (map || !window.Tmapv2) return;
      var T = window.Tmapv2;
      var c = center || { lat: 37.566535, lng: 126.9779692 };
      map = new T.Map(document.getElementById('map'), {
        center: new T.LatLng(c.lat, c.lng),
        width: '100%',
        height: '100%',
        zoom: 14,
        zoomControl: true,
        scrollwheel: true
      });
    }

    window.addEventListener('message', function (ev) {
      try {
        var data = ev.data || {};
        if (data.type === 'init') {
          ensureMap(data.center);
        } else if (data.type === 'route') {
          ensureMap(data.center);
          drawRoute(data.routeData);
        }
      } catch (e) { console.error(e); }
    });

    // ì´ˆê¸° ë¡œë“œ ì‹œ ë§µë§Œ ì¤€ë¹„ ì‹œë„ (SDKê°€ ì´ë¯¸ ë¡œë“œëœ ê²½ìš°)
    if (window.Tmapv2) ensureMap();
  </script>
</body>

</html>