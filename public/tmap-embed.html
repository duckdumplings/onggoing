<!doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tmap Embed</title>
  <style>
    html,
    body,
    #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
  <script>
    // Tmap SDK는 내부적으로 document.write를 사용하므로, 반드시 파서 차단 방식으로 삽입해야 합니다.
    (function () {
      try {
        var params = new URLSearchParams(location.search);
        var key = params.get('appKey') || '';
        document.write('<script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey=' + key + '"><\\/script>');
      } catch (e) {
        console.error('Failed to inject Tmap SDK:', e);
      }
    })();
  </script>
</head>

<body>
  <div id="map"></div>
  <script>
    var map = null;
    var polylines = [];
    var markers = [];
    var infoWindows = [];

    function clearMap() {
      polylines.forEach(function (p) { p.setMap(null); });
      markers.forEach(function (m) { m.setMap(null); });
      infoWindows.forEach(function (w) { try { w.setMap(null); } catch (e) { } });
      infoWindows = [];
      polylines = []; markers = [];
    }

    function drawRoute(routeData) {
      if (!routeData) return;
      var features = routeData.features || [];
      var T = window.Tmapv2;
      clearMap();
      var bounds = new T.LatLngBounds();
      var waypoints = (routeData.waypoints || []).map(function (w) { return new T.LatLng(w.latitude, w.longitude); });
      for (var idx = 0; idx < features.length; idx++) {
        var feature = features[idx];
        var coords = feature && feature.geometry && feature.geometry.coordinates;
        if (!coords || !coords.length) continue;
        var flat = Array.isArray(coords[0][0]) ? coords.flat(1) : coords;
        var path = flat.map(function (c) { return new T.LatLng(c[1], c[0]); });
        if (path.length === 0) continue;
        polylines.push(new T.Polyline({ path: path, strokeColor: '#FF1744', strokeWeight: 5, map: map }));
        for (var k = 0; k < path.length; k++) { bounds.extend(path[k]); }
        // 도착지 수집은 서버 제공 waypoints 사용
      }
      // 경유지 수(n) 만큼 번호 배지(1..n)
      for (var i = 0; i < waypoints.length; i++) {
        infoWindows.push(new T.InfoWindow({ position: waypoints[i], content: '<div style="background:#1f2937;color:#fff;border-radius:12px;padding:2px 6px;font-size:12px;">' + (i + 1) + '</div>', type: 2, map: map }));
      }
      // 경로 영역으로 자동 맞춤
      try { if (bounds && typeof bounds.isEmpty === 'function' && !bounds.isEmpty()) { map.fitBounds(bounds, 30); } } catch (e) { }
    }

    function ensureMap(center) {
      if (map || !window.Tmapv2) return;
      var T = window.Tmapv2;
      var c = center || { lat: 37.566535, lng: 126.9779692 };
      map = new T.Map(document.getElementById('map'), {
        center: new T.LatLng(c.lat, c.lng),
        width: '100%',
        height: '100%',
        zoom: 14,
        zoomControl: true,
        scrollwheel: true
      });
    }

    window.addEventListener('message', function (ev) {
      try {
        var data = ev.data || {};
        if (data.type === 'init') {
          ensureMap(data.center);
        } else if (data.type === 'route') {
          ensureMap(data.center);
          drawRoute(data.routeData);
        }
      } catch (e) { console.error(e); }
    });

    // 초기 로드 시 맵만 준비 시도 (SDK가 이미 로드된 경우)
    if (window.Tmapv2) ensureMap();
  </script>
</body>

</html>
    if (window.Tmapv2) ensureMap();
  </script>
</body>

</html>